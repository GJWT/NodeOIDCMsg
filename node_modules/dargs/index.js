// Copyright (c) 2017 The Authors of 'JWTS for NODE'
//
// Permission is hereby granted, free of charge, to any person obtaining a copy of
// this software and associated documentation files (the "Software"), to deal in
// the Software without restriction, including without limitation the rights to
// use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
// the Software, and to permit persons to whom the Software is furnished to do so,
// subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
// COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
// IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
// CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

'use strict';
var numberIsNan = require('number-is-nan');

function createArg(key, val, separator) {
	key = key.replace(/[A-Z]/g, '-$&').toLowerCase();
	return '--' + key + (val ? separator + val : '');
}

function match(arr, val) {
	return arr.some(function (x) {
		return x instanceof RegExp ? x.test(val) : x === val;
	});
}

function createAliasArg(key, val) {
	return '-' + key + (val ? ' ' + val : '');
}

module.exports = function (input, opts) {
	var args = [];
	var extraArgs = [];

	opts = opts || {};

	var separator = opts.useEquals === false ? ' ' : '=';

	Object.keys(input).forEach(function (key) {
		var val = input[key];
		var argFn = createArg;

		if (Array.isArray(opts.excludes) && match(opts.excludes, key)) {
			return;
		}

		if (Array.isArray(opts.includes) && !match(opts.includes, key)) {
			return;
		}

		if (typeof opts.aliases === 'object' && opts.aliases[key]) {
			key = opts.aliases[key];
			argFn = createAliasArg;
		}

		if (key === '_') {
			if (!Array.isArray(val)) {
				throw new TypeError('Expected key \'_\' to be an array, but found ' + (typeof val));
			}

			extraArgs = val;
			return;
		}

		if (val === true) {
			args.push(argFn(key, ''));
		}

		if (val === false && !opts.ignoreFalse) {
			args.push(argFn('no-' + key));
		}

		if (typeof val === 'string') {
			args.push(argFn(key, val, separator));
		}

		if (typeof val === 'number' && !numberIsNan(val)) {
			args.push(argFn(key, String(val), separator));
		}

		if (Array.isArray(val)) {
			val.forEach(function (arrVal) {
				args.push(argFn(key, arrVal, separator));
			});
		}
	});

	extraArgs.forEach(function (extraArgVal) {
		args.push(String(extraArgVal));
	});

	return args;
};
